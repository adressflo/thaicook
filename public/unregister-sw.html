<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D√©sinscrire Service Workers - Chanthana</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .container {
      background: white;
      color: #333;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #dc2626;
      margin-top: 0;
    }
    .status {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-family: monospace;
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
    }
    button {
      background: #dc2626;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
      transition: all 0.2s;
    }
    button:hover {
      background: #b91c1c;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    .success {
      background: #dcfce7;
      border: 2px solid #16a34a;
      color: #15803d;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }
    .warning {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      color: #92400e;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .step {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 15px;
      margin: 15px 0;
    }
    .step h3 {
      margin-top: 0;
      color: #1e40af;
    }
    code {
      background: #1f2937;
      color: #10b981;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üö® D√©sinscrire Tous les Service Workers</h1>

    <div class="warning">
      <strong>‚ö†Ô∏è Attention :</strong> Cette page va d√©sinscrire TOUS les Service Workers et supprimer TOUS les caches. Utilisez uniquement en cas de probl√®me critique.
    </div>

    <div class="step">
      <h3>√âtape 1 : D√©sinscrire automatiquement</h3>
      <p>Cliquez sur le bouton ci-dessous pour d√©marrer le processus automatique :</p>
      <button id="unregisterBtn" onclick="unregisterAll()">üóëÔ∏è D√©sinscrire Tous les SW</button>
      <button id="clearCacheBtn" onclick="clearAllCaches()" disabled>üßπ Supprimer Tous les Caches</button>
      <button id="reloadBtn" onclick="forceReload()" disabled>üîÑ Recharger l'Application</button>
    </div>

    <div class="status" id="status">
      <div>üìã En attente de d√©marrage...</div>
    </div>

    <div class="success" id="success">
      <strong>‚úÖ Succ√®s !</strong> Tous les Service Workers ont √©t√© d√©sinscrits.
      <br><br>
      <strong>IMPORTANT :</strong>
      <ol>
        <li>Fermez <strong>TOUS</strong> les onglets de <code>localhost:3000</code></li>
        <li>Fermez compl√®tement Chrome/Edge</li>
        <li>Rouvrez le navigateur</li>
        <li>Retournez sur <code>http://localhost:3000</code></li>
      </ol>
    </div>

    <div class="step">
      <h3>√âtape 2 : V√©rification manuelle (si n√©cessaire)</h3>
      <p>Si le bouton ne fonctionne pas, ouvrez la console (F12) et collez ce code :</p>
      <code style="display: block; padding: 10px; white-space: pre-wrap; margin-top: 10px;">
(async () => {
  console.log('üöÄ D√©marrage d√©sinscription...');

  // 1. D√©sinscrire tous les Service Workers
  const regs = await navigator.serviceWorker.getRegistrations();
  console.log(`üìã Trouv√© ${regs.length} Service Worker(s)`);

  for (const reg of regs) {
    await reg.unregister();
    console.log('‚úÖ D√©sinscrit:', reg.scope);
  }

  // 2. Supprimer tous les caches
  const cacheNames = await caches.keys();
  console.log(`üìã Trouv√© ${cacheNames.length} cache(s)`);

  for (const name of cacheNames) {
    await caches.delete(name);
    console.log('‚úÖ Cache supprim√©:', name);
  }

  console.log('‚úÖ TERMIN√â ! Fermez TOUS les onglets et red√©marrez Chrome.');
  alert('‚úÖ Tous les Service Workers d√©sinscrits ! Fermez TOUS les onglets localhost:3000 et red√©marrez Chrome.');
})();
      </code>
    </div>

    <div class="step">
      <h3>√âtape 3 : V√©rification finale</h3>
      <p>Apr√®s red√©marrage, ouvrez <code>chrome://serviceworker-internals/</code> pour v√©rifier qu'il ne reste aucun Service Worker pour <code>localhost:3000</code>.</p>
    </div>
  </div>

  <script>
    const statusDiv = document.getElementById('status');
    const successDiv = document.getElementById('success');
    const unregisterBtn = document.getElementById('unregisterBtn');
    const clearCacheBtn = document.getElementById('clearCacheBtn');
    const reloadBtn = document.getElementById('reloadBtn');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : 'üìã';
      const div = document.createElement('div');
      div.style.margin = '5px 0';
      div.style.color = type === 'error' ? '#dc2626' : type === 'success' ? '#16a34a' : '#374151';
      div.innerHTML = `[${timestamp}] ${icon} ${message}`;
      statusDiv.appendChild(div);
      statusDiv.scrollTop = statusDiv.scrollHeight;
    }

    async function unregisterAll() {
      try {
        log('üöÄ D√©marrage de la d√©sinscription des Service Workers...', 'info');
        unregisterBtn.disabled = true;

        if (!('serviceWorker' in navigator)) {
          log('‚ùå Service Workers non support√©s par ce navigateur', 'error');
          return;
        }

        const registrations = await navigator.serviceWorker.getRegistrations();
        log(`üìã Trouv√© ${registrations.length} Service Worker(s) enregistr√©(s)`, 'info');

        if (registrations.length === 0) {
          log('‚ÑπÔ∏è Aucun Service Worker √† d√©sinscrire', 'warning');
          clearCacheBtn.disabled = false;
          return;
        }

        for (const registration of registrations) {
          try {
            await registration.unregister();
            log(`‚úÖ D√©sinscrit: ${registration.scope}`, 'success');
          } catch (error) {
            log(`‚ùå Erreur d√©sinscription ${registration.scope}: ${error.message}`, 'error');
          }
        }

        log('‚úÖ Tous les Service Workers ont √©t√© d√©sinscrits !', 'success');
        clearCacheBtn.disabled = false;

      } catch (error) {
        log(`‚ùå Erreur critique: ${error.message}`, 'error');
        console.error(error);
      }
    }

    async function clearAllCaches() {
      try {
        log('üßπ D√©marrage de la suppression des caches...', 'info');
        clearCacheBtn.disabled = true;

        if (!('caches' in window)) {
          log('‚ùå Cache API non support√©e', 'error');
          return;
        }

        const cacheNames = await caches.keys();
        log(`üìã Trouv√© ${cacheNames.length} cache(s)`, 'info');

        if (cacheNames.length === 0) {
          log('‚ÑπÔ∏è Aucun cache √† supprimer', 'warning');
          reloadBtn.disabled = false;
          successDiv.style.display = 'block';
          return;
        }

        for (const cacheName of cacheNames) {
          try {
            await caches.delete(cacheName);
            log(`‚úÖ Cache supprim√©: ${cacheName}`, 'success');
          } catch (error) {
            log(`‚ùå Erreur suppression cache ${cacheName}: ${error.message}`, 'error');
          }
        }

        log('‚úÖ Tous les caches ont √©t√© supprim√©s !', 'success');
        log('üéâ PROCESSUS TERMIN√â !', 'success');
        reloadBtn.disabled = false;
        successDiv.style.display = 'block';

      } catch (error) {
        log(`‚ùå Erreur critique: ${error.message}`, 'error');
        console.error(error);
      }
    }

    function forceReload() {
      log('üîÑ Fermeture de cet onglet... Fermez TOUS les onglets localhost:3000 et red√©marrez Chrome !', 'warning');
      setTimeout(() => {
        window.close();
        // Si window.close() √©choue (onglet ouvert manuellement), rediriger
        window.location.href = 'about:blank';
      }, 2000);
    }

    // Log initial
    log('‚úÖ Page de d√©sinscription charg√©e', 'success');
    log('üëâ Cliquez sur le bouton pour commencer', 'info');
  </script>
</body>
</html>
